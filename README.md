# VHS / Virtual Hystology Staining /
## CUT: Виртуальное окрашивание гистологических изображений

Этот проект реализует **виртуальное окрашивание гистологических изображений** с помощью **Contrastive Unpaired Translation (CUT)**.  
Используется **модульный подход**, обеспечивающий:
- Разрезку больших изображений на патчи (`2048x2048` с перекрытием `512px`)
- Обучение **нейросети CUT** на патчах  
- Сохранение, загрузку и инференс модели  
- **Callbacks** для логирования и сохранения чекпоинтов  

## 📌 Основные компоненты проекта:
- **Разрезка изображений** на патчи (2048x2048) и их сборка обратно
- **Обучение модели CUT**
- **Применение обученной модели к новым изображениям**
- **Оптимизировано для GPU (Nvidia A100)**

---

## 🚀 **1. Установка**
### 📌 **1.1. Установите зависимости**
```sh
pip install torch torchvision tensorboard tqdm numpy opencv-python pillow
```

### 📌 **1.2. Клонируйте репозиторий**
```sh
git clone https://github.com/onisps/VHS_LNB.git
cd VHS_LNB
```

## 🛠 **2. Подготовка данных**
### 🛠 **2.1. Разрезка изображений**
Перед обучением необходимо разрезать большие изображения на патчи.
```sh
python make_patches.py --image path/to/original_image.png --output_patches patches/ --output_image reconstructed.png
```

Что делает этот шаг?
- **Разрезает изображение на патчи 2048x2048 с 512px перекрытием**
- **Сохраняет их в patches/**
- **Позволяет позже собрать обратно**

## 🎓 **3. Обучение модели CUT**
### 🎓 **3.1. Запуск обучения**
```sh
python train.py --source path/to/source_patches --target path/to/target_patches
```
Что делает этот шаг?
- **Загружает патчи немаркированных и окрашенных изображений**
- **Запускает CUT**
- **Сохраняет чекпоинты модели в checkpoints/**
- **Логирует метрики в TensorBoard**

### 🎓 **3.2. Просмотр логов TensorBoard**
```sh
tensorboard --logdir=logs
```
Перейдите в браузер: http://localhost:6006/

## 💾 **4. Сохранение и загрузка модели**
### 💾 **4.1. Сохранение модели после обучения**
Модель автоматически сохраняется, но можно сделать это вручную:

```python
from utils.model_utils import save_model

save_model(model, optimizer, epoch)
```

### 💾 **4.2. Загрузка модели**

```python
from utils.model_utils import load_model

model = load_model("checkpoints/cut_model_epoch_50.pth")
```

### 🎨 **5. Применение модели к новому изображению**
```sh
python apply_model.py --checkpoint checkpoints/cut_model_epoch_50.pth --input path/to/input.png --output path/to/output.png
```

Что делает этот шаг?
- **Загружает обученную модель**
- **Преобразует изображение в Tensor**
- **Пропускает его через CUT**
- **Сохраняет финальное изображение**

### 📂 **6. Структура проекта**
```
📦
├── 📂 checkpoints/         # Чекпоинты обученной модели
├── 📂 logs/                # Логи обучения для TensorBoard
├── 📂 data/                # Данные для обучения
|   ├── 📂 Raw/             # Сырые неразрезанные данные
|       ├── 📂 GT/
|       ├── 📂 raw/
|       ├── 📂 test/
|   ├── 📂 patches/         # Патчи
|       ├── 📂 raw/
|       ├── 📂 GT/
├── 📂 utils/               # Вспомогательные модули
│   ├── 🏗 cut_model.py          # Архитектура модели CUT
│   ├── 📦 dataset.py            # Датасет для обучения
│   ├── 🖼 image_processing.py   # Разрезка и сборка изображений
│   ├── 📝 metadata.py           # Получение информации об изображениях
│   ├── 💾 model_utils.py        # Функции сохранения/загрузки модели
├── 🖼 apply_model.py       # Применение обученной модели
├── 🖼 make_patches.py              # Разрезка изображений на патчи
├── 🎓 train.py             # Обучение модели CUT
├── 📜 README.md            # Документация проекта

```

### 🛠 **7. Возможные улучшения**
- **Улучшить сборку больших изображений после инференса**
- **Добавить пакетную обработку изображений**
- **Оптимизировать инференс модели (TorchScript)**
- **Добавить поддержку других GAN-архитектур**